<!DOCTYPE html>
<!--
  ____                       _               ____      _     _
 |  _ \ _ __ __ ___      __ | |__  _   _    / __ \  __| |___| |__   __ ___      __
 | | | | '__/ _` \ \ /\ / / | '_ \| | | |  / / _` |/ _` / __| '_ \ / _` \ \ /\ / /
 | |_| | | | (_| |\ V  V /  | |_) | |_| | | | (_| | (_| \__ \ | | | (_| |\ V  V /
 |____/|_|  \__,_| \_/\_/   |_.__/ \__, |  \ \__,_|\__,_|___/_| |_|\__,_| \_/\_/
                                   |___/    \____/

 Remix at will. - @dshaw

 Inspired by:
   @rem - Canvas random color http://rem.im/collab-drawing.html
   @mrdoob - Canvas badassery http://mrdoob.com/lab/javascript/multiuserpad/
   @thomasfuchs - Touch support in http://everytimezone.com
-->
<html>
  <head>
    <meta charset=utf-8>
    <title>Draw by @dshaw</title>
    <meta name=viewport content=Ówidth=device-widthÓ>
    <style>
      body {
        margin: 0px; overflow: hidden;
        font-family:sans-serif; font-size:1.8em; text-align:center;
        color:black
      }
      a { color:black; text-decoration:none; cursor:pointer }
      a:hover { color:#0084B4 }
      header { display:block }
      canvas  { position:absolute; top:0; left:0; border:4px solid #efefef; cursor: crosshair }
      #info {
        position: absolute; top:0; width:100%; padding:0.1em 0.5em; background-color:#efefef;
        vertical-align:baseline;
        -moz-box-shadow:inset 0 0 .1em black;
        -webkit-box-shadow:inset 0 0 .1em black;
        box-shadow:inset 0 0 .1em black;
      }
      #info div { display:inline-block; margin:0 .25em }
      #project { font-weight:bold }
      #colorpicker { padding:0.1em; font-size:0.7em }
      #colorstate { margin:0; padding:0 .4em; vertical-align:middle }
    </style>
  </head>
  <body>
    <canvas id=canvas></canvas>
    <header id=info>
      <div>
        <span id=project>Draw</span>
        <span id=attrib>by: <a href="http://twitter.com/dshaw/" target=twitter>@dshaw</a></span>
      </div>
      <div id=options>
        <div id=colorstate>
          <input id=colorpicker type=color>
        </div>
      </div>
      <div><a id=reset>reset</a></div>
      <div><a id=playback>playback</a></div>
      <div><a id=export>export</a></div>
    </header>

    <script>
      var usercolor = document.getElementById("usercolor"),
          colorstate = document.getElementById("colorstate"),
          colorpicker = document.getElementById("colorpicker"),
          reset = document.getElementById("reset"),
          playback = document.getElementById("playback"),
          exp = document.getElementById("export"), // Safari doesn't like window.export.
          canvas = document.getElementById("canvas"),
          context = canvas.getContext("2d"),
          defaultColor = "rgba(0, 0, 0, 0.1)",
          drawing = false,
          supportsPlaceholder = ("placeholder" in document.createElement("input")),
          supportsTouch = ("createTouch" in document),
          supportsLocalStorage = (("localStorage" in window) && window[localStorage] !== null),
          strokes = [];

      var displayColor = function(color) {
        if (supportsPlaceholder) {
          colorpicker.placeholder = color;
        }
        colorstate.style.backgroundColor = color;
        colorstate.title = color;
      };

      var resetCanvas = function() {
        canvas.width = window.innerWidth;
			  canvas.height = window.innerHeight;
        context.strokeStyle = defaultColor;
        displayColor(context.strokeStyle);
        context.fillStyle = "rgb(255, 255, 255)";
        context.fillRect(0, 0, canvas.width, canvas.height);
        strokes = [];
      };

      var coordinates = function(event) {
        var x, y;
        if (event.touches) {
          x = event.touches[0].pageX;
          y = event.touches[0].pageY;
        } else {
          x = event.pageX;
          y = event.pageY;
        }
        return {
          x : x,
          y : y
        };
      };

      var drawStart = function(event) {
        var r, g, b,
            randomColor = function() { return (~~(Math.random() * 255)) },
            r = g = b = randomColor,
            strokeStyle = "rgba("+r()+", "+b()+", "+g()+", 0.1)",
            coords = coordinates(event);

        drawing = true;
        lineStart(coords, strokeStyle);
        displayColor(strokeStyle);
//        context.strokeStyle;
//        context.beginPath();
//        context.moveTo(coords.x, coords.y);

        if (supportsLocalStorage) {
          var stroke = {
            style : strokeStyle,
            line : [coords]
          }
          strokes.push(stroke);
        }
        return false;
      };

      var drawMove = function(event) {
        var x, y,
            coords = coordinates(event, this);
        if (drawing) {
          lineDraw(coords);
//          context.lineTo(coords.x, coords.y);
//          context.stroke();

          if (supportsLocalStorage) {
            var strokeid = strokes.length - 1;
            strokes[strokeid].line.push(coords);
          }
        }
      };

      var drawEnd = function() {
        if (supportsLocalStorage) {
          var count = strokes.length,
              id = count - 1;
          localStorage["stroke."+id] = JSON.stringify(strokes);
          localStorage.count = strokes.length;
        }
        drawing = false;
      };

      var lineStart = function(coordinates, strokeStyle) {
        context.strokeStyle = strokeStyle;
        context.beginPath();
        context.moveTo(coordinates.x, coordinates.y);
      };

      var lineDraw = function(coordinates) {
        context.lineTo(coordinates.x, coordinates.y);
        context.stroke();
      };

      var loadPlayback = function(speed) {
        if (!supportsLocalStorage && ("count" in localStorage)) return;

        var speed = speed || 0,
            count = localStorage.count,
            load = function(n) {
              var data = localStorage.getItem("stroke."+n);
              if (!data) return;
              var strokeList = JSON.parse(data);
              strokeList.forEach(function(stroke) {
                var style = stroke.style || defaultColor,
                    line = stroke.line || [],
                    linelen = line.length;
                strokes.push(stroke);
                if (linelen > 0) {
                  lineStart(line[0], style);
                  for (var i=1; i < linelen; i++) {
                    lineDraw(line[i]);
                  }
                }
              });
            };

        for (var cur=0; cur < count; cur++) {
          setTimeout(load(cur), speed * cur);
        }
      };


      // init
			resetCanvas();
      loadPlayback();


      canvas[supportsTouch ? "ontouchstart" : "onmousedown"] = drawStart;
      canvas[supportsTouch ? "ontouchmove" : "onmousemove"] = drawMove;
      canvas[supportsTouch ? "ontouchend" : "onmouseup"] = drawEnd;

      reset.onclick = function(event) {
        event.preventDefault();
        resetCanvas();
        if (supportsLocalStorage) {
          localStorage.clear();
        }
      };

      playback.onclick = function(event) {
        event.preventDefault();
        resetCanvas();
        alert("Starting playback...");
        loadPlayback(3000);
      };

      exp.onclick = function(event) {
        event.preventDefault();
        window.open( canvas.toDataURL("image/png"), "draw" );
      };
    </script>
  </body>
</html>
