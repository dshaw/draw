<!DOCTYPE html>
<!--
  ____                       _               ____      _     _
 |  _ \ _ __ __ ___      __ | |__  _   _    / __ \  __| |___| |__   __ ___      __
 | | | | '__/ _` \ \ /\ / / | '_ \| | | |  / / _` |/ _` / __| '_ \ / _` \ \ /\ / /
 | |_| | | | (_| |\ V  V /  | |_) | |_| | | | (_| | (_| \__ \ | | | (_| |\ V  V /
 |____/|_|  \__,_| \_/\_/   |_.__/ \__, |  \ \__,_|\__,_|___/_| |_|\__,_| \_/\_/
                                   |___/    \____/

 Remix at will. - @dshaw

 Inspired by:
   @rem - Canvas random color http://rem.im/collab-drawing.html
   @mrdoob - Canvas badassery http://mrdoob.com/lab/javascript/multiuserpad/
   @thomasfuchs - Touch support in http://everytimezone.com
-->
<html>
  <head>
    <meta charset=utf-8>
    <title>Draw by @dshaw</title>
    <meta name=viewport content=Óinitial-scale=1.0, width=device-widthÓ>
    <style>
      body {
        margin: 0px; overflow: hidden;
        font-family:sans-serif; font-size:1.8em; text-align:center;
        color:black
      }
      a { color:black; text-decoration:none; cursor:pointer }
      a:hover { color:#0084B4 }
      header { display:block }
      #canvas  { position:absolute; top:0; left:0; border:4px solid #efefef; cursor: crosshair }
      #info {
        position: absolute; top:0; width:100%; padding:0.1em 0.5em; background-color:#efefef;
        vertical-align:baseline;
        -moz-box-shadow:inset 0 0 .1em black;
        -webkit-box-shadow:inset 0 0 .1em black;
        box-shadow:inset 0 0 .1em black;
      }
      #info div { display:inline-block; margin:0 .25em }
      #project { font-weight:bold }
      #colorpicker { padding:0.1em; font-size:0.7em }
      #colorstate { margin:0; padding:0 .4em; vertical-align:middle }
      #toolbar {
        position:absolute; bottom:0;
        width:100%; margin:0; padding:0; vertical-align:middle;
        background-color:rgba(0, 0, 0, 0.8); color:white;
        -moz-box-shadow:black -2px 0 10px;
        -webkit-box-shadow:black -2px 0 10px;
        box-shadow:black -2px 0 10px;
      }
      #palettecanvas { height:72px; cursor:crosshair }
    </style>
  </head>
  <body>
    <canvas id=canvas></canvas>
    <header id=info>
      <div>
        <span id=project>Draw</span>
        <span id=attrib>by: <a href="http://twitter.com/dshaw/" target=twitter>@dshaw</a></span>
      </div>
      <div id=options>
        <div id=colorstate>
          <input id=colorpicker type=hidden>
          <input id=strokesize type=range value=1 min=0.1 max=100>
        </div>
      </div>
      <div><a id=reset>reset</a></div>
      <div><a id=playback>playback</a></div>
      <div><a id=export>export</a></div>
    </header>
    <div id=toolbar>
      <canvas id=palettecanvas></canvas>
    </div>

    <script>
      var info = document.getElementById("info"),
          usercolor = document.getElementById("usercolor"),
          colorstate = document.getElementById("colorstate"),
          colorpicker = document.getElementById("colorpicker"),
          strokesize = document.getElementById("strokesize"),
          reset = document.getElementById("reset"),
          playback = document.getElementById("playback"),
          exp = document.getElementById("export"), // "export" is a reserved word in ECMAScript 5.
          //palette = document.getElementById("palette"),
          palettecanvas = document.getElementById("palettecanvas"), // used by palette to extract color data
          palettecontext = palettecanvas.getContext("2d"),
          canvas = document.getElementById("canvas"),
          context = canvas.getContext("2d"),
          defaultColor = "rgba(0, 0, 0, 0.1)",
          drawing = false,
          random = true,
          supportsPlaceholder = ("placeholder" in document.createElement("input")),
          supportsTouch = ("createTouch" in document),
          supportsLocalStorage = (("localStorage" in window) && window[localStorage] !== null),
          strokes = [];

      var displayColor = function(color) {
        colorstate.style.backgroundColor = color;
      };

      var clearColor = function() {
        colorpicker.value = "";
        random = true;
        displayColor(defaultColor);
      };

      var getColor = function() {
        var color,
            r, g, b,
            randomColor = function() { return (~~(Math.random() * 255)) },
            r = g = b = randomColor;
        return (random) ? "rgba("+r()+","+b()+","+g()+",0.1)" : colorpicker.value;
      };

      var setColor = function(color) {
        colorpicker.value = color;
        random = false;
        displayColor(color);
      };

      var resetCanvas = function() {
        strokes = [];
        canvas.width = window.innerWidth;
			  canvas.height = window.innerHeight;
        context.lineWidth = strokesize.title = strokesize.value || 1;
        context.strokeStyle = defaultColor;
        random = true;
        clearColor();
        displayColor(context.strokeStyle);
        palettecanvas.width = 900;
			  palettecanvas.height = 72;
        context.fillStyle = palettecontext.fillStyle = "white";
        context.fillRect(0, 0, canvas.width, canvas.height);

        // draw toolbar
        var fillColor = "rgb(255,255,255)";
        for (var i=0;i<6;i++) {
          for (var j=0;j<6;j++) {
            for (var k=0;k<6;k++) {
              palettecontext.fillStyle = 'rgb('+Math.floor(255-142.5*i)+','+Math.floor(255-42.5*j)+','+Math.floor(255-42.5*k)+')';
              palettecontext.fillRect((k*150)+(j*25),i*25,25,25);
            }
          }
        }

        var greys = "white #AAA #777 black #333 #555".split(" "),
            size = 25,
            x = "0 0 0 875 875 875".split(" "),
            y = "0 25 50 0 25 50".split(" ");

        for (var i=0, len = greys.length; i<len; i++) {
          palettecontext.fillStyle = greys[i];
          palettecontext.fillRect(x[i], y[i], size, size);
        }
      };

      var coordinates = function(event) {
        var x, y;
        if (event.touches) {
          x = event.touches[0].pageX;
          y = event.touches[0].pageY;
        } else {
          x = event.pageX;
          y = event.pageY;
        }
        return {
          x : x,
          y : y
        };
      };

      var drawStart = function(event) {
        var color = getColor(),
            coords = coordinates(event);

        drawing = true;
        displayColor(color);
        lineStart(coords, color);

        if (supportsLocalStorage) {
          var stroke = {
            style : color,
            line : [coords]
          }
          strokes.push(stroke);
        }
        return false;
      };

      var drawMove = function(event) {
        var x, y,
            coords = coordinates(event, this);
        if (drawing) {
          lineDraw(coords);

          if (supportsLocalStorage) {
            var strokeid = strokes.length - 1;
            if (strokes[strokeid].line) strokes[strokeid].line.push(coords);
          }
        }
      };

      var drawEnd = function() {
        if (supportsLocalStorage) {
          var count = strokes.length,
              id = count - 1;
          localStorage["stroke."+id] = JSON.stringify(strokes);
          localStorage.count = strokes.length;
        }
        drawing = false;
      };

      var lineStart = function(coordinates, strokeStyle) {
        context.beginPath();
        context.lineWidth = strokesize.value || 1;
        context.strokeStyle = strokeStyle;
        context.moveTo(coordinates.x, coordinates.y);
      };

      var lineDraw = function(coordinates) {
        context.lineTo(coordinates.x, coordinates.y);
        context.stroke();
      };

      var loadPlayback = function(speed) {
        if (!supportsLocalStorage && ("count" in localStorage)) return;

        var speed = speed || 0,
            count = localStorage.count,
            load = function(n) {
              var data = localStorage.getItem("stroke."+n);
              if (!data) return;
              var strokeList = JSON.parse(data);
              strokeList.forEach(function(stroke) {
                var style = stroke.style || defaultColor,
                    line = stroke.line || [],
                    linelen = line.length;
                strokes.push(stroke);
                if (linelen > 0) {
                  lineStart(line[0], style);
                  for (var i=1; i < linelen; i++) {
                    lineDraw(line[i]);
                  }
                }
              });
            };

        for (var cur=0; cur < count; cur++) {
          setTimeout(load(cur), speed * cur);
        }
      };


      // init
			resetCanvas();
      loadPlayback();


      canvas[supportsTouch ? "ontouchstart" : "onmousedown"] = drawStart;
      canvas[supportsTouch ? "ontouchmove" : "onmousemove"] = drawMove;
      canvas[supportsTouch ? "ontouchend" : "onmouseup"] = drawEnd;

      reset.onclick = function(event) {
        event.preventDefault();
        resetCanvas();
        if (supportsLocalStorage) {
          localStorage.clear();
        }
      };

      playback.onclick = function(event) {
        event.preventDefault();
        resetCanvas();
        alert("Starting playback...");
        loadPlayback(3000);
      };

      exp.onclick = function(event) {
        event.preventDefault();
        window.open( canvas.toDataURL("image/png"), "draw" );
      };

      palettecanvas[supportsTouch ? "ontouchstart" : "onmousedown"] = function(event) {
        event.preventDefault();
        var data = palettecontext.getImageData(event.offsetX, event.offsetY, 1, 1).data,
            color = "rgba("+data[0]+","+data[1]+","+data[2]+",0.1)";
        setColor(color);
      };

      palettecanvas.ondblclick = function(event) {
        event.preventDefault();
        clearColor();
      };

      strokesize.onchange = function(event) {
        strokesize.title = strokesize.value;
      };
    </script>
  </body>
</html>
